@model List<SeifDigital.Models.AuditLog>

@{
    ViewData["Title"] = "Audit Logs";

    int pageNo = (int)(ViewBag.Page ?? 1);
    int pageSize = (int)(ViewBag.PageSize ?? 25);
    int total = (int)(ViewBag.Total ?? 0);
    int totalPages = (int)(ViewBag.TotalPages ?? 1);

    if (totalPages < 1) totalPages = 1;
    if (pageNo < 1) pageNo = 1;
    if (pageNo > totalPages) pageNo = totalPages;

    int startItem = total == 0 ? 0 : ((pageNo - 1) * pageSize + 1);
    int endItem = Math.Min(pageNo * pageSize, total);

    string actorUser = (string)(ViewBag.ActorUser ?? "");
    string eventType = (string)(ViewBag.EventType ?? "");
    string outcome = (string)(ViewBag.Outcome ?? "");
    string targetId = (string)(ViewBag.TargetId ?? "");
    string fromUtc = (string)(ViewBag.FromUtc ?? "");
    string toUtc = (string)(ViewBag.ToUtc ?? "");

    int retentionDays = 0;
    try { retentionDays = (int)(ViewBag.RetentionDays ?? 0); } catch { }

    string esc(string s) => Uri.EscapeDataString(s ?? "");
}

<div class="container mt-4" style="max-width:1100px;">

    <h2>Audit Logs</h2>

    @{
        // query string pentru export (include filtrele)
        string baseQs =
            $"actorUser={esc(actorUser)}&eventType={esc(eventType)}&outcome={esc(outcome)}&targetId={esc(targetId)}&fromUtc={esc(fromUtc)}&toUtc={esc(toUtc)}";

        string exportCsvHref = $"/Audit/ExportCsv?{baseQs}";
        string exportPdfHref = $"/Audit/ExportPdf?{baseQs}";
    }

    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
        <a asp-controller="Audit"
           asp-action="Settings"
           class="btn btn-sm btn-outline-secondary">
            ⚙️ Audit Settings
        </a>

        <a class="btn btn-sm btn-outline-primary" href="@exportCsvHref">
            ⬇ Export CSV
        </a>

        <a class="btn btn-sm btn-outline-primary" href="@exportPdfHref" target="_blank">
            🖨 Export PDF
        </a>

        <span class="ms-auto text-muted small">
            @if (retentionDays > 0)
            {
                <text>Retention: <b>@retentionDays</b> zile</text>
            }
        </span>
    </div>

    <div class="text-muted mb-2">
        Afișez <b>@startItem</b> - <b>@endItem</b> din <b>@total</b> • Pagina <b>@pageNo</b> / <b>@totalPages</b>
    </div>

    <form method="get" class="row g-2 mb-3">
        <div class="col-md-3">
            <input class="form-control" name="actorUser" placeholder="ActorUser"
                   value="@actorUser" />
        </div>

        <div class="col-md-3">
            <input class="form-control" name="eventType" placeholder="EventType (ex: Secret.ViewPassword)"
                   value="@eventType" />
        </div>

        <div class="col-md-2">
            <select class="form-select" name="outcome">
                <option value="">Outcome (all)</option>
                <option value="Success" selected="@(outcome == "Success")">Success</option>
                <option value="Fail" selected="@(outcome == "Fail")">Fail</option>
            </select>
        </div>

        <div class="col-md-2">
            <input class="form-control" name="targetId" placeholder="TargetId"
                   value="@targetId" />
        </div>

        <div class="col-md-3">
            <input class="form-control" type="datetime-local" name="fromUtc"
                   value="@fromUtc" />
        </div>

        <div class="col-md-3">
            <input class="form-control" type="datetime-local" name="toUtc"
                   value="@toUtc" />
        </div>

        <div class="col-md-2">
            <button class="btn btn-primary w-100" type="submit">Filtrează</button>
        </div>

        <div class="col-md-2">
            <a class="btn btn-outline-secondary w-100" href="/Audit">Reset</a>
        </div>
    </form>

    <style>
        .audit-outcome { min-width: 90px; }
        .audit-ip { max-width: 15ch; white-space: normal; word-break: break-word; }
        .audit-ua { max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .audit-event code { white-space: nowrap; }
    </style>

    <div class="table-responsive">
        <table class="table table-sm table-striped align-middle small">
            <thead>
                <tr>
                    <th>Time (UTC)</th>
                    <th>Event</th>
                    <th>Actor</th>
                    <th>Target</th>
                    <th class="audit-outcome">Outcome</th>
                    <th class="audit-ip">IP</th>
                    <th class="audit-ua">UA</th>
                    <th style="width:1%;">Open</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var x in Model)
                {
                    <tr>
                        <td>@x.EventTimeUtc.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td class="audit-event"><code>@x.EventType</code></td>
                        <td>@x.ActorUser</td>
                        <td>@x.TargetType @x.TargetId</td>
                        <td class="audit-outcome">@x.Outcome</td>
                        <td class="audit-ip">@x.ClientIp</td>
                        <td class="audit-ua">@x.UserAgent</td>

                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary"
                                    onclick="openAuditDetails(this)"
                                    data-time="@x.EventTimeUtc.ToString("yyyy-MM-dd HH:mm:ss")"
                                    data-event="@x.EventType"
                                    data-actor="@x.ActorUser"
                                    data-target="@($"{x.TargetType} {x.TargetId}")"
                                    data-outcome="@x.Outcome"
                                    data-reason="@(x.Reason ?? "")"
                                    data-ip="@(x.ClientIp ?? "")"
                                    data-ua="@System.Net.WebUtility.HtmlEncode(x.UserAgent ?? "")"
                                    data-details="@System.Net.WebUtility.HtmlEncode(x.DetailsJson ?? "")"
                                    data-corr="@(x.CorrelationId ?? "")">
                                Detalii
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @{
        bool prevDisabled = pageNo <= 1;
        bool nextDisabled = pageNo >= totalPages;

        int prevPage = pageNo - 1;
        int nextPage = pageNo + 1;

        string prevHref = prevDisabled ? "#" : $"/Audit?{baseQs}&page={prevPage}";
        string nextHref = nextDisabled ? "#" : $"/Audit?{baseQs}&page={nextPage}";
    }

    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted small">
            Pagina <b>@pageNo</b> din <b>@totalPages</b>
        </div>

        <div class="btn-group">
            <a class="btn btn-outline-secondary @(prevDisabled ? "disabled" : "")"
               href="@prevHref"
               tabindex="@(prevDisabled ? "-1" : "0")"
               aria-disabled="@(prevDisabled ? "true" : "false")">
                ‹ Prev
            </a>

            <a class="btn btn-outline-secondary @(nextDisabled ? "disabled" : "")"
               href="@nextHref"
               tabindex="@(nextDisabled ? "-1" : "0")"
               aria-disabled="@(nextDisabled ? "true" : "false")">
                Next ›
            </a>
        </div>
    </div>
</div>

<!-- Modal Detalii -->
<div class="modal fade" id="auditDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Audit details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <dl class="row mb-3">
                    <dt class="col-sm-3">Time (UTC)</dt>
                    <dd class="col-sm-9" id="ad_time"></dd>

                    <dt class="col-sm-3">Event</dt>
                    <dd class="col-sm-9"><code id="ad_event"></code></dd>

                    <dt class="col-sm-3">Actor</dt>
                    <dd class="col-sm-9" id="ad_actor"></dd>

                    <dt class="col-sm-3">Target</dt>
                    <dd class="col-sm-9" id="ad_target"></dd>

                    <dt class="col-sm-3">Outcome</dt>
                    <dd class="col-sm-9" id="ad_outcome"></dd>

                    <dt class="col-sm-3">Reason</dt>
                    <dd class="col-sm-9" id="ad_reason"></dd>

                    <dt class="col-sm-3">Client IP</dt>
                    <dd class="col-sm-9" id="ad_ip"></dd>

                    <dt class="col-sm-3">Correlation</dt>
                    <dd class="col-sm-9"><code id="ad_corr"></code></dd>

                    <dt class="col-sm-3">User-Agent</dt>
                    <dd class="col-sm-9">
                        <pre class="mb-0" style="white-space:pre-wrap" id="ad_ua"></pre>
                    </dd>
                </dl>

                <hr />

                <h6 class="mb-2">Audit fin (Mesaje)</h6>
                <div class="text-muted small mb-2">Se completează automat doar pentru evenimentele de tip <code>Message.*</code>.</div>

                <dl class="row mb-3">
                    <dt class="col-sm-3">From</dt>
                    <dd class="col-sm-9" id="ad_from">—</dd>

                    <dt class="col-sm-3">To</dt>
                    <dd class="col-sm-9" id="ad_to">—</dd>

                    <dt class="col-sm-3">SourceType</dt>
                    <dd class="col-sm-9" id="ad_source">—</dd>

                    <dt class="col-sm-3">MessageId</dt>
                    <dd class="col-sm-9" id="ad_messageId">—</dd>

                    <dt class="col-sm-3">OriginalId</dt>
                    <dd class="col-sm-9" id="ad_originalId">—</dd>

                    <dt class="col-sm-3">CreatedUtc</dt>
                    <dd class="col-sm-9" id="ad_createdUtc">—</dd>

                    <dt class="col-sm-3">SavedUtc</dt>
                    <dd class="col-sm-9" id="ad_savedUtc">—</dd>
                </dl>

                <hr />

                <h6 class="mb-2">Details JSON</h6>
                <pre class="mb-0" style="white-space:pre-wrap" id="ad_details"></pre>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Închide</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function decodeHtmlEntities(str) {
            if (!str) return "";
            const txt = document.createElement("textarea");
            txt.innerHTML = str;
            return txt.value;
        }

        function setText(id, val) {
            const el = document.getElementById(id);
            if (el) el.textContent = val ?? "";
        }

        function openAuditDetails(btn) {
            const get = (name) => btn.getAttribute(name) || "";

            const detailsDecoded = decodeHtmlEntities(get("data-details"));
            const uaDecoded = decodeHtmlEntities(get("data-ua"));

            setText("ad_time", get("data-time"));
            setText("ad_event", get("data-event"));
            setText("ad_actor", get("data-actor"));
            setText("ad_target", get("data-target"));
            setText("ad_outcome", get("data-outcome"));
            setText("ad_reason", get("data-reason"));
            setText("ad_ip", get("data-ip"));
            setText("ad_corr", get("data-corr"));
            setText("ad_ua", uaDecoded);

            // defaults pentru audit fin
            setText("ad_from", "—");
            setText("ad_to", "—");
            setText("ad_source", "—");
            setText("ad_messageId", "—");
            setText("ad_originalId", "—");
            setText("ad_createdUtc", "—");
            setText("ad_savedUtc", "—");

            let pretty = detailsDecoded || "";
            try {
                if (detailsDecoded) {
                    const obj = JSON.parse(detailsDecoded);
                    pretty = JSON.stringify(obj, null, 2);

                    if (obj) {
                        if (obj.from) setText("ad_from", obj.from);
                        if (obj.to) setText("ad_to", obj.to);
                        if (obj.sourceType) setText("ad_source", obj.sourceType);
                        if (obj.messageId != null) setText("ad_messageId", String(obj.messageId));
                        if (obj.originalId != null) setText("ad_originalId", String(obj.originalId));
                        if (obj.createdUtc) setText("ad_createdUtc", obj.createdUtc);
                        if (obj.savedUtc) setText("ad_savedUtc", obj.savedUtc);
                    }
                }
            } catch { }

            setText("ad_details", pretty);

            const modalEl = document.getElementById("auditDetailsModal");
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    </script>
}
