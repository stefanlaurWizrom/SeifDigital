@model SeifDigital.Models.InformatieSensibilaListViewModel

@{
    ViewData["Title"] = "Parole";

    string q = (string)(ViewBag.Q ?? "");
    int pageNo = Model?.Page ?? 1;
    int pageSize = Model?.PageSize ?? 25;
    int total = Model?.TotalCount ?? 0;

    int totalPages = (int)Math.Ceiling(total / (double)pageSize);
    if (totalPages < 1) totalPages = 1;

    if (pageNo < 1) pageNo = 1;
    if (pageNo > totalPages) pageNo = totalPages;

    // compute paging and qEsc as before
    var prevDisabled = pageNo <= 1;
    var nextDisabled = pageNo >= totalPages;
    var qEsc = Uri.EscapeDataString(q ?? "");
    var prevPage = pageNo - 1;
    var nextPage = pageNo + 1;
    var prevHref = prevDisabled ? "#" : $"/Home?{(string.IsNullOrEmpty(qEsc) ? "" : $"q={qEsc}&")}page={prevPage}";
    var nextHref = nextDisabled ? "#" : $"/Home?{(string.IsNullOrEmpty(qEsc) ? "" : $"q={qEsc}&")}page={nextPage}";

    var loginEmail = Context.Session.GetString("LoginEmail");
    var who = !string.IsNullOrWhiteSpace(loginEmail) ? loginEmail : (User.Identity?.Name ?? "");
}

<div class="container mt-4">
    @* Token folosit de fetch (AJAX) *@
    @Html.AntiForgeryToken()

    <h2 class="mb-1">Parole</h2>

    <div class="text-muted mb-2">
        Logat ca: <b>@who</b>
    </div>

    <p>Aici poti salva date sensibile (parole), care vor fi criptate dupa fiecare inregistrare salvata.</p>

    <hr />

    <h4>Adaugă o înregistrare nouă</h4>

    <form asp-controller="Home" asp-action="SalveazaDateSensibile" method="post" class="mb-4">
        @Html.AntiForgeryToken()

        <div class="mb-3">
            <label class="form-label">Titlu (ex: RDP Server Contabilitate)</label>
            <input type="text" name="titlu" class="form-control" placeholder="Ex: RDP 10.10.10.5" required />
        </div>

        <div class="mb-3">
            <label class="form-label">User (pentru RDP / aplicație)</label>
            <input type="text" name="usernameSalvat" class="form-control" placeholder="Ex: CONTAB\\ion.popescu" required />
        </div>

        <div class="mb-3">
            <label class="form-label">Parola</label>

            <div class="input-group">
                <input id="inputParola"
                       type="password"
                       name="parolaClara"
                       class="form-control"
                       placeholder="Parola..."
                       required
                       autocomplete="new-password" />

                <button id="btnPeek"
                        class="btn btn-outline-secondary"
                        type="button"
                        aria-label="Arată parola cât timp ții apăsat">
                    👁
                </button>
            </div>

            <div class="form-text">
                Ține apăsat pe 👁 ca să vezi parola.
            </div>
        </div>

        @* NOU: Detalii *@
        <div class="mb-3">
            <label class="form-label">Detalii</label>
            <textarea name="detalii"
                      class="form-control"
                      rows="3"
                      placeholder="Ex: URL, port, observații, pași de conectare..."></textarea>
            <div class="form-text">Detaliile se salvează criptat (ca parola).</div>
        </div>

        <button type="submit" class="btn btn-primary">Salvează criptat</button>
    </form>

    <hr />

    <h4>Date salvate</h4>

    <!-- Search form (GET) -->
    <form method="get" class="row g-2 mb-3">
        <div class="col-md-8">
            <input class="form-control" name="q" value="@q" placeholder="Caută în titlu, user salvat sau detalii..." />
        </div>
        <div class="col-md-2">
            <button class="btn btn-outline-primary w-100" type="submit">Caută</button>
        </div>
        <div class="col-md-2">
            <a class="btn btn-outline-secondary w-100" href="@Url.Action("Index", "Home")">Reset</a>
        </div>
    </form>

    <div class="mb-2 text-muted">
        Afișez @Model.StartItemIndex - @Model.EndItemIndex din @Model.TotalCount
    </div>

    <table class="table table-striped align-middle">
        <thead>
            <tr>
                <th>Id</th>
                <th>Titlu</th>
                <th>User salvat</th>
                <th>Parola</th>
                <th>Acțiuni</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Items)
            {
                <tr>
                    <td>@item.Id</td>
                    <td>@item.TitluAplicatie</td>
                    <td>@item.UsernameSalvat</td>

                    <td>
                        <span id="pwd-@item.Id" class="text-muted" data-visible="0">••••••</span>
                    </td>

                    <td class="d-flex gap-2 flex-wrap">
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                id="btn-@item.Id"
                                onclick="toggleParola(@item.Id)">
                            Arată parola
                        </button>

                        <button type="button"
                                class="btn btn-sm btn-outline-primary"
                                id="copy-@item.Id"
                                onclick="copyParola(@item.Id)">
                            Copiază
                        </button>

                        @* Detalii *@
                        <button type="button"
                                class="btn btn-sm btn-outline-info"
                                id="det-@item.Id"
                                onclick="showDetalii(@item.Id)">
                            Detalii
                        </button>

                        @* NOU: Trimite -> deschide modal *@
                        <button type="button"
                                class="btn btn-sm btn-outline-primary"
                                onclick="openSendModal(@item.Id)">
                            Trimite
                        </button>

                        <form asp-controller="Home"
                              asp-action="Sterge"
                              method="post"
                              onsubmit="return confirm('Sigur vrei să ștergi această înregistrare?');"
                              style="margin:0;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@item.Id" />
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                Șterge
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted small">
            Pagina <b>@pageNo</b> din <b>@totalPages</b>
        </div>

        <div class="btn-group">
            <a class="btn btn-outline-secondary @(prevDisabled ? "disabled" : "")"
               href="@prevHref"
               tabindex="@(prevDisabled ? "-1" : "0")"
               aria-disabled="@(prevDisabled ? "true" : "false")">
                ‹ Prev
            </a>

            <a class="btn btn-outline-secondary @(nextDisabled ? "disabled" : "")"
               href="@nextHref"
               tabindex="@(nextDisabled ? "-1" : "0")"
               aria-disabled="@(nextDisabled ? "true" : "false")">
                Next ›
            </a>
        </div>
    </div>
</div>

@* Modal Detalii *@
<div class="modal fade" id="detaliiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalii</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="detaliiText" style="white-space:pre-wrap; margin:0;"></pre>
            </div>
        </div>
    </div>
</div>

@* Modal: Trimite către alt user *@
<div class="modal fade" id="sendModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-controller="Home" asp-action="SendSecret" method="post" class="mb-0">
                @Html.AntiForgeryToken()

                <div class="modal-header">
                    <h5 class="modal-title">Trimite înregistrarea</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="id" id="sendSecretId" value="" />

                    <label class="form-label">Email destinatar</label>
                    <input type="text"
                           class="form-control"
                           name="recipientEmail"
                           id="sendRecipientEmail"
                           placeholder="ex: coleg@wizrom.ro"
                           required />
                    <div class="form-text">Introdu emailul utilizatorului din WizVault.</div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Renunță</button>
                    <button type="submit" class="btn btn-primary">Trimite</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ===== B5.1: peek + hold-to-reveal în câmpul de introducere =====
        (function setupPasswordInputUX() {
            const input = document.getElementById("inputParola");
            const btn = document.getElementById("btnPeek");
            if (!input || !btn) return;

            const PEEK_MS = 2000;
            let peekTimer = null;
            let isHoldingReveal = false;

            function setHidden() {
                if (!isHoldingReveal) input.type = "password";
            }

            function setVisible() {
                input.type = "text";
            }

            function clearPeekTimer() {
                if (peekTimer) {
                    clearTimeout(peekTimer);
                    peekTimer = null;
                }
            }

            input.addEventListener("input", () => {
                if (isHoldingReveal) return;
                clearPeekTimer();
                setVisible();
                peekTimer = setTimeout(() => setHidden(), PEEK_MS);
            });

            const startHold = (e) => {
                e.preventDefault();
                isHoldingReveal = true;
                clearPeekTimer();
                setVisible();
            };

            const endHold = () => {
                isHoldingReveal = false;
                setHidden();
            };

            btn.addEventListener("mousedown", startHold);
            btn.addEventListener("mouseup", endHold);
            btn.addEventListener("mouseleave", endHold);
            btn.addEventListener("touchstart", startHold, { passive: false });
            btn.addEventListener("touchend", endHold);
            btn.addEventListener("touchcancel", endHold);

            document.addEventListener("visibilitychange", () => {
                if (document.hidden) endHold();
            });
        })();

        // === setare: cât timp rămâne parola vizibilă (milisecunde) ===
        const AUTO_HIDE_MS = 10000; // 10 secunde

        // păstrăm timer-ele pe fiecare rând (id -> timeoutId)
        const hideTimers = {};

        function stopAutoHide(id) {
            if (hideTimers[id]) {
                clearTimeout(hideTimers[id]);
                delete hideTimers[id];
            }
        }

        function startAutoHide(id, btn) {
            stopAutoHide(id);
            hideTimers[id] = setTimeout(() => {
                hidePassword(id, btn);
            }, AUTO_HIDE_MS);
        }

        function hidePassword(id, btn) {
            stopAutoHide(id);

            const span = document.getElementById("pwd-" + id);
            span.textContent = "••••••";
            span.classList.add("text-muted");
            span.dataset.visible = "0";

            btn.textContent = "Arată parola";
            btn.classList.remove("btn-outline-danger");
            btn.classList.add("btn-outline-secondary");
        }

        async function toggleParola(id) {
            const span = document.getElementById("pwd-" + id);
            const btn = document.getElementById("btn-" + id);

            if (span.dataset.visible === "1") {
                hidePassword(id, btn);
                return;
            }

            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : "";

            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = "Se încarcă...";

            try {
                const response = await fetch("/Home/GetParolaJson", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
                    },
                    body: `id=${encodeURIComponent(id)}&__RequestVerificationToken=${encodeURIComponent(token)}`
                });

                if (response.status === 401) {
                    alert("Sesiune expirată sau 2FA nevalidat. Reîncarcă pagina.");
                    btn.textContent = oldText;
                    return;
                }

                if (!response.ok) {
                    alert("Eroare la citirea parolei. Încearcă din nou.");
                    btn.textContent = oldText;
                    return;
                }

                const data = await response.json();

                if (!data || data.ok !== true) {
                    alert(data?.message || "Eroare necunoscută.");
                    btn.textContent = oldText;
                    return;
                }

                span.textContent = data.parola;
                span.classList.remove("text-muted");
                span.dataset.visible = "1";

                btn.textContent = "Ascunde parola";
                btn.classList.remove("btn-outline-secondary");
                btn.classList.add("btn-outline-danger");

                startAutoHide(id, btn);
            }
            catch (e) {
                alert("Eroare de rețea / server. Vezi Console (F12).");
                console.error(e);
                btn.textContent = oldText;
            }
            finally {
                btn.disabled = false;
            }
        }

        // ===== B6: Copy to clipboard + auto-clear (best effort) =====
        const CLIPBOARD_CLEAR_MS = 15000; // 15 secunde

        async function copyParola(id) {
            const span = document.getElementById("pwd-" + id);
            const btn = document.getElementById("copy-" + id);

            if (!span || !btn) return;

            if (span.dataset.visible !== "1") {
                alert("Întâi apasă «Arată parola», apoi poți copia.");
                return;
            }

            const parola = span.textContent || "";
            if (!parola || parola === "••••••") {
                alert("Nu am ce copia.");
                return;
            }

            const oldText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "Copiez...";

            try {
                await navigator.clipboard.writeText(parola);

                btn.textContent = "Copiat!";
                btn.classList.remove("btn-outline-primary");
                btn.classList.add("btn-success");

                setTimeout(async () => {
                    try { await navigator.clipboard.writeText(""); } catch { }
                }, CLIPBOARD_CLEAR_MS);

                setTimeout(() => {
                    btn.textContent = oldText;
                    btn.classList.remove("btn-success");
                    btn.classList.add("btn-outline-primary");
                    btn.disabled = false;
                }, 1500);
            }
            catch (e) {
                console.error(e);

                try {
                    const tmp = document.createElement("textarea");
                    tmp.value = parola;
                    tmp.style.position = "fixed";
                    tmp.style.left = "-9999px";
                    document.body.appendChild(tmp);
                    tmp.focus();
                    tmp.select();
                    document.execCommand("copy");
                    document.body.removeChild(tmp);

                    btn.textContent = "Copiat!";
                    btn.classList.remove("btn-outline-primary");
                    btn.classList.add("btn-success");

                    setTimeout(() => {
                        btn.textContent = oldText;
                        btn.classList.remove("btn-success");
                        btn.classList.add("btn-outline-primary");
                        btn.disabled = false;
                    }, 1500);
                }
                catch {
                    btn.textContent = oldText;
                    btn.disabled = false;
                    alert("Nu pot accesa clipboard-ul (permisiuni browser). Încearcă Ctrl+C manual.");
                }
            }
        }

        // ===== Arată Detalii (AJAX + modal) =====
        async function showDetalii(id) {
            const btn = document.getElementById("det-" + id);
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : "";

            const oldText = btn ? btn.textContent : "Detalii";
            if (btn) { btn.disabled = true; btn.textContent = "Se încarcă..."; }

            try {
                const response = await fetch("/Home/GetDetaliiJson", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
                    },
                    body: `id=${encodeURIComponent(id)}&__RequestVerificationToken=${encodeURIComponent(token)}`
                });

                if (response.status === 401) {
                    alert("Sesiune expirată sau 2FA nevalidat. Reîncarcă pagina.");
                    return;
                }

                const data = await response.json();

                if (!response.ok || !data || data.ok !== true) {
                    alert(data?.message || "Nu pot încărca detaliile.");
                    return;
                }

                document.getElementById("detaliiText").textContent = data.detalii || "(fără detalii)";

                const modal = new bootstrap.Modal(document.getElementById("detaliiModal"));
                modal.show();
            }
            catch (e) {
                console.error(e);
                alert("Eroare de rețea / server la încărcarea detaliilor.");
            }
            finally {
                if (btn) { btn.disabled = false; btn.textContent = oldText; }
            }
        }

        // ===== NOU: Trimite -> modal =====
        function openSendModal(id) {
            const hiddenId = document.getElementById("sendSecretId");
            const emailInput = document.getElementById("sendRecipientEmail");

            if (hiddenId) hiddenId.value = id;
            if (emailInput) {
                emailInput.value = "";
                setTimeout(() => emailInput.focus(), 150);
            }

            const modalEl = document.getElementById("sendModal");
            const modal = new bootstrap.Modal(modalEl);
            modal.show();
        }
    </script>
}
