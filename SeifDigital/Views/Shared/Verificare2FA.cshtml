@{
    ViewData["Title"] = "Verificare Securitate";
}

<div class="text-center">
    <h2>Verificare 2FA</h2>
    <p>Cere un cod de securitate pe emailul tău de domeniu, apoi introdu-l mai jos.</p>

    @* DEBUG (opțional): arătăm userul Windows *@
    @if (ViewBag.DebugUser != null && !string.IsNullOrWhiteSpace((string)ViewBag.DebugUser))
    {
        <p class="text-muted">
            User: <b>@ViewBag.DebugUser</b>
        </p>
    }

    @* Info: cod trimis / cooldown etc *@
    @if (ViewBag.Info != null)
    {
        <div class="alert alert-info" style="max-width:520px; margin: 12px auto;">
            @ViewBag.Info
        </div>
    }

    @* Eroare: AD/Smtp/Cooldown etc *@
    @if (ViewBag.Mesaj != null)
    {
        <div class="alert alert-danger" style="max-width:520px; margin: 12px auto;">
            @ViewBag.Mesaj
        </div>
    }

    @* Buton: trimite cod (B9) *@
    <form asp-controller="Auth" asp-action="TrimiteCod" method="post" style="max-width:520px; margin: 0 auto 14px auto;">
        @Html.AntiForgeryToken()
        <button type="submit"
                class="btn btn-primary"
                id="btnTrimiteCod">
            Trimite cod pe email
        </button>
    </form>

    @* pentru test: arătăm unde s-a trimis *@
    @if (ViewBag.EmailTrimis != null)
    {
        <p class="text-muted">
            Cod trimis la: <b>@ViewBag.EmailTrimis</b>
        </p>
    }

    <form asp-controller="Auth" asp-action="VerificaCod" method="post" style="max-width:520px; margin: 0 auto;">
        @Html.AntiForgeryToken()

        <div class="mb-3">
            <input type="text"
                   name="codIntrodus"
                   placeholder="Introdu codul de 6 cifre"
                   class="form-control text-center"
                   maxlength="6"
                   inputmode="numeric"
                   autocomplete="one-time-code"
                   required />
        </div>

        <button type="submit" class="btn btn-success">
            Verifică și Intră în Seif
        </button>
    </form>
    

</div>
@section Scripts {
    <script>
        (function () {
            const btn = document.getElementById("btnTrimiteCod");
            if (!btn) return;

            // căutăm mesajul de cooldown (~xx secunde)
            const infoAlerts = document.querySelectorAll(".alert-info, .alert-danger");

            let seconds = null;

            infoAlerts.forEach(a => {
                const m = a.textContent.match(/~\s*(\d+)\s*sec/i);
                if (m) {
                    seconds = parseInt(m[1], 10);
                }
            });

            if (!seconds || seconds <= 0) return;

            // dezactivăm butonul
            btn.disabled = true;
            const originalText = "Trimite cod pe email";

            function tick() {
                if (seconds <= 0) {
                    btn.disabled = false;
                    btn.textContent = originalText;
                    return;
                }

                btn.textContent = `Trimite cod (${seconds}s)`;
                seconds--;
                setTimeout(tick, 1000);
            }

            tick();
        })();
    </script>
}